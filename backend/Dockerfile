ARG python_base
FROM ${python_base}:3-alpine

ENV TZ Europe/Paris
RUN set -ex \
    && apk --no-cache add tzdata \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

ENV PYTHONUNBUFFERED 1

RUN addgroup -S django \
    && adduser -S -g '' -G django django \
    && apk add --no-cache 'su-exec>=0.2'

WORKDIR /app

ARG development
COPY requirements.txt dev-requirements.txt ./
RUN set -ex \
    && apk add --no-cache --virtual .build-deps \
           gcc \
           linux-headers \
           ${development:+make} \
           musl-dev \
           postgresql-dev \
           python3-dev \
    && pip install --no-cache-dir \
           -r "${development:+dev-}requirements.txt" \
    && apk add --no-cache \
           libpq \
    && apk del .build-deps

COPY . ./

RUN python -m compileall .

ENV PORT 8000
EXPOSE $PORT

ENTRYPOINT [ "./docker-entrypoint.sh" ]

CMD [ "gunicorn", "home_web.wsgi", \
      "--bind", "0.0.0.0:$PORT", \
      "--name", "home_web", \
      "--access-logfile", "-", \
      "--error-logfile", "-" ]
